<!DOCTYPE html>
<html lang="en"><head>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/tabby.min.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.6.40">

  <meta name="author" content="Alex Edwards">
  <meta name="author" content="Zane Billings">
  <title>SISMID R for ID Materials (2025) – Module XX: FP Applications</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../site_libs/revealjs/dist/theme/quarto-bbe7401fe57d4b791b917637bb662036.css">
  <link href="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Module XX: FP Applications</h1>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
<a href="https://sph.emory.edu/profile/faculty/alex-edwards">Alex Edwards</a> 
</div>
</div>
<div class="quarto-title-author">
<div class="quarto-title-author-name">
<a href="https://wzbillings.com/">Zane Billings</a> 
</div>
</div>
</div>

</section>
<section id="learning-goals" class="slide level2">
<h2>Learning goals</h2>
<ol type="1">
<li>Use function-writing and functional programming techniques to deal with applied epidemiology problems.</li>
<li>Optimize your own function with <code>optim()</code>.</li>
<li>Simulate and solve differential equations with <code>deSolve</code>.</li>
</ol>
</section>
<section>
<section id="optim" class="title-slide slide level1 center">
<h1><code>optim()</code></h1>

</section>
<section id="what-is-optim" class="slide level2">
<h2>What is <code>optim()</code></h2>
<ul>
<li>Generic R interface to optimization algorithms.</li>
<li><strong>Optimization</strong>: for a function <span class="math inline">\(f(x)\)</span>, find <span class="math inline">\(x^\star\)</span> so that <span class="math inline">\(f(x^\star) \geq f(x)\)</span> for any other <span class="math inline">\(x\)</span>.</li>
<li>Takes a function to be <strong>minimized</strong> as an argument. (If you want the maximum, you need to put a negative sign.)</li>
</ul>
</section>
<section id="simple-example" class="slide level2 scrollable">
<h2>Simple example</h2>
<ul>
<li>Find the maximum value of <span class="math inline">\(f(x) = \sin(x)e^{-x^2}\)</span>.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a></a><span class="fu">curve</span>(</span>
<span id="cb1-2"><a></a>    <span class="fu">sin</span>(x) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>x<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb1-3"><a></a>    <span class="at">from =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">to =</span> <span class="dv">2</span>, <span class="at">n =</span> <span class="dv">1000</span></span>
<span id="cb1-4"><a></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="ModuleXX-optim-differential-equations_files/figure-revealjs/unnamed-chunk-1-1.png" width="960"></p>
</figure>
</div>
</div>
</div>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a></a><span class="fu">optim</span>(</span>
<span id="cb2-2"><a></a>    <span class="at">par =</span> your initial guess to start at,</span>
<span id="cb2-3"><a></a>    <span class="at">fn =</span> the <span class="cf">function</span> to optimize,</span>
<span id="cb2-4"><a></a>    <span class="at">method =</span> the method to use <span class="cf">for</span> optimization,</span>
<span id="cb2-5"><a></a>    <span class="at">control =</span> a list of other parameters</span>
<span id="cb2-6"><a></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a></a>res <span class="ot">&lt;-</span> <span class="fu">optim</span>(</span>
<span id="cb3-2"><a></a>    <span class="at">par =</span> <span class="dv">0</span>,</span>
<span id="cb3-3"><a></a>    <span class="at">fn =</span> \(x) <span class="fu">sin</span>(x) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>x<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb3-4"><a></a>    <span class="at">method =</span> <span class="st">"BFGS"</span>,</span>
<span id="cb3-5"><a></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">fnscale =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="co"># This gets the maximum</span></span>
<span id="cb3-6"><a></a>)</span>
<span id="cb3-7"><a></a>res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$par
[1] 0.6532841

$value
[1] 0.396653

$counts
function gradient 
       8        7 

$convergence
[1] 0

$message
NULL</code></pre>
</div>
</div>
</div>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a></a><span class="fu">curve</span>(</span>
<span id="cb5-2"><a></a>    <span class="fu">sin</span>(x) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>x<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb5-3"><a></a>    <span class="at">from =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">to =</span> <span class="dv">2</span>, <span class="at">n =</span> <span class="dv">1000</span></span>
<span id="cb5-4"><a></a>)</span>
<span id="cb5-5"><a></a><span class="fu">abline</span>(<span class="at">h =</span> res<span class="sc">$</span>value, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb5-6"><a></a><span class="fu">abline</span>(<span class="at">v =</span> res<span class="sc">$</span>par, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="ModuleXX-optim-differential-equations_files/figure-revealjs/unnamed-chunk-4-1.png" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="arguments-explained" class="slide level2">
<h2>Arguments explained</h2>
<ul>
<li><code>par</code> is a vector of your parameter values. You need to pick starting values for the algorithm, usually the choice isn’t super important. (It can be for complicated problems.)</li>
<li><code>fn</code> is the function you want to minimize (or maximize with the <code>fnscale = -1</code> control argument).</li>
<li><code>method</code> is the optimizer to use, this is a really technical choice. I prefer <code>BFGS</code> but <code>Brent</code> is also good for 1 parameter problems and <code>Nelder-Mead</code> is usually good for 2+ parameter problems if <code>BFGS</code> isn’t working.</li>
<li><code>control</code> has a lot of complicated options that you usually won’t need, <code>fnscale = -1</code> is the main one to know about.</li>
</ul>
</section>
<section id="why-use-optim" class="slide level2 incremental">
<h2>Why use <code>optim()</code></h2>
<ul>
<li><code>lm()</code> and <code>glm()</code>, etc., do all of that stuff for me? Why do I need to do it by hand?</li>
<li>Sometimes you have a problem that doesn’t fit neatly into a pre-written model!</li>
<li>We’ll get to an example where this is true, but let’s build our way up.</li>
</ul>
</section>
<section id="optim-sampling-example" class="slide level2 scrollable">
<h2>Optim sampling example</h2>
<ul>
<li>Suppose you’re in charge of monitoring mosquito traps for West Nile Virus at some health department (see, e.g., PMCID: PMC2631741).</li>
<li>You have 20 different traps you can check, and at each trap you select 10 mosquitoes for testing. We don’t have enough money or good enough equipment to test all of those mosquitoes, so we pool them together and get an overall yes (1) or no (0) for presence of mosquitoes.</li>
<li>This month, 7 out of 20 traps tested positive.</li>
<li>Estimate the underlying mosquito infection risk from the pooled data using maximum likelihood.</li>
</ul>
<div class="fragment">
<ul>
<li>Note that you can do this as a binomial <code>glm()</code>. But this won’t be true in our next example.</li>
<li>Let’s work through the math you need.</li>
</ul>
</div>
<div class="fragment">
<ul>
<li>Given an infection rate, <span class="math inline">\(p\)</span>, the probability that pool <span class="math inline">\(i\)</span> tests positive is <span class="math display">\[
P(+) = 1 - (1 - p)^{10}
\]</span></li>
<li>The probability that 7 pools out of 20 tested positive is then <span class="math display">\[
{{7}\choose{20}} \bigg(1 - (1 - p)^{10}\bigg)^7 \bigg((1 - p)^{10}\bigg)^{20-7}
\]</span></li>
<li>This is written in R as <code>dbinom(7, size = 20, prob = 1 - (1 - p)^10)</code>.</li>
<li>For technical reasons, it is easier to minimize the negative log likelihood than it is to directly maximize the likelihood.</li>
<li>You should write a function that gives the negative log likelihood and pass this function to <code>optim()</code> to find the best value of <span class="math inline">\(p\)</span>.</li>
</ul>
</div>
<div class="fragment">
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a></a>initial_guess <span class="ot">&lt;-</span> <span class="dv">7</span> <span class="sc">/</span> <span class="dv">20</span></span>
<span id="cb6-2"><a></a></span>
<span id="cb6-3"><a></a><span class="co"># You could write out the math for this function by hand if you wanted to</span></span>
<span id="cb6-4"><a></a><span class="co"># But dbinom uses some nice tricks to be faster and more accurate.</span></span>
<span id="cb6-5"><a></a>nll <span class="ot">&lt;-</span> <span class="cf">function</span>(p) {</span>
<span id="cb6-6"><a></a>  nll <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">dbinom</span>(<span class="dv">7</span>, <span class="at">size =</span> <span class="dv">20</span>, <span class="at">prob =</span> <span class="dv">1</span> <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> p)<span class="sc">^</span><span class="dv">10</span>, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-7"><a></a>  <span class="fu">return</span>(nll)</span>
<span id="cb6-8"><a></a>}</span>
<span id="cb6-9"><a></a></span>
<span id="cb6-10"><a></a><span class="fu">optim</span>(</span>
<span id="cb6-11"><a></a>    <span class="at">par =</span> initial_guess,</span>
<span id="cb6-12"><a></a>    <span class="at">fn =</span> nll,</span>
<span id="cb6-13"><a></a>    <span class="at">method =</span> <span class="st">"L-BFGS-B"</span>, <span class="co"># Or "Brent"</span></span>
<span id="cb6-14"><a></a>    <span class="at">lower =</span> <span class="fl">0.001</span>,</span>
<span id="cb6-15"><a></a>    <span class="at">upper =</span> <span class="fl">0.999</span></span>
<span id="cb6-16"><a></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$par
[1] 0.04217128

$value
[1] 1.690642

$counts
function gradient 
      15       15 

$convergence
[1] 0

$message
[1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"</code></pre>
</div>
</div>
<ul>
<li>The output tells us that <span class="math inline">\(p \approx 0.02\)</span> has the minimal negative log-likelihood at 1.69, so from the data we have, this is the most likely mosquito infection rate.</li>
</ul>
</div>
</section>
<section id="bonus-stage" class="slide level2">
<h2>Bonus stage!</h2>
<ul>
<li>Usually getting an approximate Wald-type confidence interval is very easy with <code>optim()</code>.</li>
<li>We need to refit the model with <code>hessian = TRUE</code>. (Math terms: the Hessian returned here is the negative Fisher information matrix. The standard errors of the parameters are the square roots of the diagnol of the inverse Fisher information matrix.)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a></a>res <span class="ot">&lt;-</span> <span class="fu">optim</span>(</span>
<span id="cb8-2"><a></a>    <span class="at">par =</span> <span class="fl">0.1</span>,</span>
<span id="cb8-3"><a></a>    <span class="at">fn =</span> nll,</span>
<span id="cb8-4"><a></a>    <span class="at">method =</span> <span class="st">"L-BFGS-B"</span>,</span>
<span id="cb8-5"><a></a>    <span class="at">lower =</span> <span class="fl">0.00001</span>,</span>
<span id="cb8-6"><a></a>    <span class="at">upper =</span> <span class="fl">0.99999</span>,</span>
<span id="cb8-7"><a></a>    <span class="at">hessian =</span> <span class="cn">TRUE</span></span>
<span id="cb8-8"><a></a>)</span>
<span id="cb8-9"><a></a>est <span class="ot">&lt;-</span> res<span class="sc">$</span>par</span>
<span id="cb8-10"><a></a>se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">solve</span>(res<span class="sc">$</span>hessian)))</span>
<span id="cb8-11"><a></a></span>
<span id="cb8-12"><a></a><span class="co"># Approximate CI</span></span>
<span id="cb8-13"><a></a>ci_lower <span class="ot">&lt;-</span> est <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se</span>
<span id="cb8-14"><a></a>ci_upper <span class="ot">&lt;-</span> est <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se</span>
<span id="cb8-15"><a></a><span class="fu">c</span>(ci_lower, ci_upper)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01137851 0.07296406</code></pre>
</div>
</div>
<ul>
<li>So in our report, we could say that we estimate an 4.2% WNV infection risk for mosquitoes in our area with a 95% CI of about 1.1% to 7.3%.</li>
</ul>
</section>
<section id="you-try-it" class="slide level2 scrollable">
<h2>You try it!</h2>
<ul>
<li>Let’s extend the binomial example to a situation where we don’t have a built-in ML option in R.</li>
<li>In real life, your mosquito traps are probably <strong>heterogeneous</strong>. One process that can contribute to heterogeneity is <strong>zero-inflation</strong>: at some sites, there are no mosquitoes with WNV because WNV hasn’t been introduced to that area yet.</li>
<li>So now we know that if we observe a negative trap, it could be because there’s no WNV at all, or because we didn’t catch any mosquitoes with WNV. Call the probability that WNV has been introduced into the trap region <span class="math inline">\(\kappa\)</span>.</li>
<li>Estimate <span class="math inline">\(p\)</span>, the mosquito infection rate, and <span class="math inline">\(\kappa\)</span>, the zero-inflation probability, assuming that 7 of 20 pools were positive and each pool had 10 mosquitos.</li>
</ul>
<div class="fragment">
<ul>
<li>We introduce <span class="math inline">\(\kappa\)</span> into our model by now modeling the probability that a pool tests positive as <span class="math display">\[
P(+) = \kappa\bigg(1 - (1 - p)^{10}\bigg).
\]</span></li>
<li>Now you just need to handle optimizing two parameters at one time. The input to your function needs to be a length two vector.</li>
</ul>
</div>
<div class="fragment">
<ul>
<li>Hint: Your initial guess should be a length two vector (<code>c(..., ...)</code>) and your optimization function should look like this.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a></a>nll_zip <span class="ot">&lt;-</span> <span class="cf">function</span>(par) {</span>
<span id="cb10-2"><a></a>    p <span class="ot">&lt;-</span> par[<span class="dv">1</span>]</span>
<span id="cb10-3"><a></a>    kappa <span class="ot">&lt;-</span> par[<span class="dv">2</span>]</span>
<span id="cb10-4"><a></a>    </span>
<span id="cb10-5"><a></a>    ...</span>
<span id="cb10-6"><a></a>    </span>
<span id="cb10-7"><a></a>    <span class="fu">return</span>(nll)</span>
<span id="cb10-8"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="fragment">
<ul>
<li>Hint: when you call <code>optim()</code> you need to make sure that <code>par</code>, <code>lower</code>, and <code>upper</code> are all length-two vectors. You should still use the “L-BFGS-B” method for this problem.</li>
</ul>
</div>
<div class="fragment">
<ul>
<li>Solution:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a></a>nll_zip <span class="ot">&lt;-</span> <span class="cf">function</span>(par) {</span>
<span id="cb11-2"><a></a>  p_infect <span class="ot">&lt;-</span> par[<span class="dv">1</span>]</span>
<span id="cb11-3"><a></a>  kappa <span class="ot">&lt;-</span> par[<span class="dv">2</span>]</span>
<span id="cb11-4"><a></a>  </span>
<span id="cb11-5"><a></a>  p_pos <span class="ot">&lt;-</span> kappa <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> p_infect) <span class="sc">^</span> <span class="dv">10</span>)</span>
<span id="cb11-6"><a></a>  </span>
<span id="cb11-7"><a></a>  nll <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">dbinom</span>(<span class="dv">7</span>, <span class="dv">20</span>, <span class="at">prob =</span> p_pos, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-8"><a></a>  </span>
<span id="cb11-9"><a></a>  <span class="fu">return</span>(nll)</span>
<span id="cb11-10"><a></a>}</span>
<span id="cb11-11"><a></a></span>
<span id="cb11-12"><a></a>initial_guess <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.5</span>)</span>
<span id="cb11-13"><a></a>res <span class="ot">&lt;-</span> <span class="fu">optim</span>(</span>
<span id="cb11-14"><a></a>    <span class="at">par =</span> initial_guess,</span>
<span id="cb11-15"><a></a>    <span class="at">fn =</span> nll_zip,</span>
<span id="cb11-16"><a></a>    <span class="at">method =</span> <span class="st">"L-BFGS-B"</span>,</span>
<span id="cb11-17"><a></a>    <span class="at">lower =</span> <span class="fu">rep</span>(<span class="fl">0.001</span>, <span class="dv">2</span>),</span>
<span id="cb11-18"><a></a>    <span class="at">upper =</span> <span class="fu">rep</span>(<span class="fl">0.999</span>, <span class="dv">2</span>),</span>
<span id="cb11-19"><a></a>    <span class="at">hessian =</span> <span class="cn">TRUE</span></span>
<span id="cb11-20"><a></a>)</span>
<span id="cb11-21"><a></a>res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$par
[1] 0.1068171 0.5171114

$value
[1] 1.690642

$counts
function gradient 
      14       14 

$convergence
[1] 0

$message
[1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"

$hessian
         [,1]      [,2]
[1,] 307.8070 111.32366
[2,] 111.3237  40.27431</code></pre>
</div>
</div>
</div>
<div class="fragment">
<ul>
<li>That’s all you had to do for this problem, but if you try to get the CI using the same method, you can see that this approximate method does a terrible job here.</li>
<li>Unfortunately there’s no easy fix for this specific problem.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a></a>est <span class="ot">&lt;-</span> res<span class="sc">$</span>par</span>
<span id="cb13-2"><a></a>se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">solve</span>(res<span class="sc">$</span>hessian)))</span>
<span id="cb13-3"><a></a></span>
<span id="cb13-4"><a></a><span class="co"># Approximate CI</span></span>
<span id="cb13-5"><a></a>ci_lower <span class="ot">&lt;-</span> est <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se</span>
<span id="cb13-6"><a></a>ci_upper <span class="ot">&lt;-</span> est <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se</span>
<span id="cb13-7"><a></a><span class="fu">cat</span>(</span>
<span id="cb13-8"><a></a>    <span class="fu">paste0</span>(<span class="st">"Infection risk: "</span>, <span class="fu">round</span>(est[[<span class="dv">1</span>]], <span class="dv">2</span>), <span class="st">" ("</span>, <span class="fu">round</span>(ci_lower[[<span class="dv">1</span>]], <span class="dv">2</span>),</span>
<span id="cb13-9"><a></a>                 <span class="st">", "</span>, <span class="fu">round</span>(ci_upper[[<span class="dv">1</span>]], <span class="dv">2</span>), <span class="st">")"</span>),</span>
<span id="cb13-10"><a></a>    <span class="fu">paste0</span>(<span class="st">"Risk WNV in area: "</span>, <span class="fu">round</span>(est[[<span class="dv">2</span>]], <span class="dv">2</span>), <span class="st">" ("</span>, <span class="fu">round</span>(ci_lower[[<span class="dv">2</span>]], <span class="dv">2</span>),</span>
<span id="cb13-11"><a></a>                 <span class="st">", "</span>, <span class="fu">round</span>(ci_upper[[<span class="dv">2</span>]], <span class="dv">2</span>), <span class="st">")"</span>),</span>
<span id="cb13-12"><a></a>    <span class="at">sep =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb13-13"><a></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Infection risk: 0.11 (-6.31, 6.52)
Risk WNV in area: 0.52 (-17.22, 18.26)</code></pre>
</div>
</div>
</div>
</section>
<section id="bonus-problems" class="slide level2">
<h2>Bonus problems</h2>
<ul>
<li><p>The likelihood of a sample with multiple observations is the product of the likelihood for each datapoint. (Or, the negative log-likelihood of the sample is the <em>sum</em> of the negative log-likelihood of each datapoint.) Using the <code>mos-nyc.csv</code> dataset, which describes the number of positive pools out of total pools collected for some counties in New York State, estimate the mosquito infection rate under both the simple and mixture models. Assume these samples use 50 mosquitoes per pool instead of 10.</p></li>
<li><p>For an extra super bonus problem (not solved here), figure out how to combine your <code>optim()</code> code with what we learned about bootstrapping to compare the Wald-type CI from the Hessian with a bootstrap CI.</p></li>
</ul>
</section></section>
<section>
<section id="desolve" class="title-slide slide level1 center">
<h1><code>deSolve</code></h1>

</section>
<section id="differential-equations-and-other-types-of-horoscopes" class="slide level2">
<h2>Differential equations and other types of horoscopes</h2>
<ul>
<li>A differential equation is an equation with a derivative in it. E.g: <span class="math display">\[
\frac{d^2x}{dt^2} + \omega^2 x = 0
\]</span> is a differential equation from physics.</li>
<li>Here <strong>x</strong> is position, <strong>t</strong> is time, and <span class="math inline">\(\omega\)</span> is some constant.</li>
<li>This differential equation describes how springs and pendulums move over time.</li>
</ul>
</section>
<section id="spring-motion" class="slide level2 scrollable">
<h2>Spring motion</h2>
<ul>
<li>This differential equation describes how a spring moves over time.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="..\images\spring.jpg"></p>
<figcaption>Source: https://vamosarema.com/</figcaption>
</figure>
</div>
<div class="fragment">
<ul>
<li>Through math magic, we can figure out that the curve traced out by the spring position has to be <span class="math display">\[
f(x) = A\cos(\omega t) + B \sin(\omega t)
\]</span></li>
<li>Where <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span> are real numbers that are determined by where the spring starts and its initial speed.</li>
<li>Since we know this, we can make a plot of the spring movement.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a></a><span class="co"># Parameters</span></span>
<span id="cb15-2"><a></a>omega <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="sc">*</span> pi  <span class="co"># angular frequency = sqrt(k / m)</span></span>
<span id="cb15-3"><a></a>A <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span>          <span class="co"># initial displacement</span></span>
<span id="cb15-4"><a></a>B <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> omega         <span class="co"># initial velocity divided by omega</span></span>
<span id="cb15-5"><a></a></span>
<span id="cb15-6"><a></a><span class="co"># Time vector</span></span>
<span id="cb15-7"><a></a>t <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="at">by =</span> <span class="fl">0.01</span>)  <span class="co"># 0 to 2 seconds</span></span>
<span id="cb15-8"><a></a></span>
<span id="cb15-9"><a></a><span class="co"># Analytical solution</span></span>
<span id="cb15-10"><a></a>x <span class="ot">&lt;-</span> A <span class="sc">*</span> <span class="fu">cos</span>(omega <span class="sc">*</span> t) <span class="sc">+</span> B <span class="sc">*</span> <span class="fu">sin</span>(omega <span class="sc">*</span> t)</span>
<span id="cb15-11"><a></a></span>
<span id="cb15-12"><a></a><span class="co"># Plot</span></span>
<span id="cb15-13"><a></a><span class="fu">plot</span>(t, x, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb15-14"><a></a>     <span class="at">xlab =</span> <span class="st">"Time (seconds)"</span>, <span class="at">ylab =</span> <span class="st">"Position"</span>,</span>
<span id="cb15-15"><a></a>     <span class="at">main =</span> <span class="st">"Spring movement"</span>)</span>
<span id="cb15-16"><a></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="ModuleXX-optim-differential-equations_files/figure-revealjs/unnamed-chunk-10-1.png" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="fragment">
<ul>
<li>So what do we do if we don’t know the math magic?</li>
<li>We use a <strong>numerical solver</strong>. In R, the best one is in the <code>deSolve</code> package. These are tools that use good approximations to get the solution.</li>
<li>The only downside is that we have to write our code in a very specific way.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a></a><span class="co"># We have to do some transformations to make this DE work with deSolve</span></span>
<span id="cb16-2"><a></a><span class="co"># but you can ignore that for now or you can google "transform a second order</span></span>
<span id="cb16-3"><a></a><span class="co"># DE into system of first order DEs" if you want.</span></span>
<span id="cb16-4"><a></a><span class="fu">library</span>(deSolve)</span>
<span id="cb16-5"><a></a></span>
<span id="cb16-6"><a></a><span class="co"># Function for our DE (system)</span></span>
<span id="cb16-7"><a></a>spring_ode <span class="ot">&lt;-</span> <span class="cf">function</span>(t, state, parameters) {</span>
<span id="cb16-8"><a></a>  <span class="fu">with</span>(<span class="fu">as.list</span>(<span class="fu">c</span>(state, parameters)), {</span>
<span id="cb16-9"><a></a>    dx1 <span class="ot">&lt;-</span> x2</span>
<span id="cb16-10"><a></a>    dx2 <span class="ot">&lt;-</span> <span class="sc">-</span>omega<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> x1</span>
<span id="cb16-11"><a></a>    </span>
<span id="cb16-12"><a></a>    <span class="fu">list</span>(<span class="fu">c</span>(dx1, dx2))</span>
<span id="cb16-13"><a></a>  })</span>
<span id="cb16-14"><a></a>}</span>
<span id="cb16-15"><a></a></span>
<span id="cb16-16"><a></a><span class="co"># Initial state: x(0) = -2, dx/dt(0) = 1</span></span>
<span id="cb16-17"><a></a>state <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">x1 =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">x2 =</span> <span class="dv">1</span>)</span>
<span id="cb16-18"><a></a></span>
<span id="cb16-19"><a></a><span class="co"># Time points to solve for</span></span>
<span id="cb16-20"><a></a>times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="at">by =</span> <span class="fl">0.01</span>)</span>
<span id="cb16-21"><a></a></span>
<span id="cb16-22"><a></a><span class="co"># Parameters list</span></span>
<span id="cb16-23"><a></a>parameters <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">omega =</span> omega)</span>
<span id="cb16-24"><a></a></span>
<span id="cb16-25"><a></a><span class="co"># Solve ODE</span></span>
<span id="cb16-26"><a></a>out <span class="ot">&lt;-</span> <span class="fu">ode</span>(<span class="at">y =</span> state, <span class="at">times =</span> times, <span class="at">func =</span> spring_ode, <span class="at">parms =</span> parameters)</span>
<span id="cb16-27"><a></a><span class="fu">str</span>(out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 'deSolve' num [1:201, 1:3] 0 0.01 0.02 0.03 0.04 0.05 0.06 0.07 0.08 0.09 ...
 - attr(*, "dimnames")=List of 2
  ..$ : NULL
  ..$ : chr [1:3] "time" "x1" "x2"
 - attr(*, "istate")= int [1:21] 2 222 449 NA 6 6 0 52 22 NA ...
 - attr(*, "rstate")= num [1:5] 0.01 0.01 2.01 0 0
 - attr(*, "lengthvar")= int 2
 - attr(*, "type")= chr "lsoda"</code></pre>
</div>
</div>
</div>
<div class="fragment">
<ul>
<li>We can plot the solution to make sure it looks the same too.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a></a><span class="co"># Convert to data frame</span></span>
<span id="cb18-2"><a></a>out_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(out)</span>
<span id="cb18-3"><a></a></span>
<span id="cb18-4"><a></a><span class="co"># Plot displacement vs time</span></span>
<span id="cb18-5"><a></a><span class="fu">plot</span>(out_df<span class="sc">$</span>time, out_df<span class="sc">$</span>x1, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">3</span>,</span>
<span id="cb18-6"><a></a>     <span class="at">xlab =</span> <span class="st">"Time (seconds)"</span>, <span class="at">ylab =</span> <span class="st">"Position"</span>,</span>
<span id="cb18-7"><a></a>     <span class="at">main =</span> <span class="st">"Numerical Solution of spring movement"</span>)</span>
<span id="cb18-8"><a></a><span class="fu">lines</span>(t, x, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb18-9"><a></a></span>
<span id="cb18-10"><a></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="ModuleXX-optim-differential-equations_files/figure-revealjs/unnamed-chunk-12-1.png" width="960"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>They are exactly the same.</li>
</ul>
</div>
</section>
<section id="ok-wait-a-second." class="slide level2 incremental">
<h2>OK, wait a second.</h2>
<ul>
<li>This is obviously very exciting. But who cares about springs?</li>
<li>It turns out that for many biological/social processes, it’s easier to write down how things change than it is to write down exact formulas.</li>
<li>And derivatives describe how things change.</li>
</ul>
</section>
<section id="compartment-models" class="slide level2 scrollable">
<h2>Compartment models</h2>
<ul>
<li>If we divide up a population into <strong>states</strong> or <strong>compartments</strong>, usually we can write down how we expect people to move between those compartments.</li>
<li>For example, consider the famous SIR model.</li>
</ul>

<img data-src="../images/SIR-model.png" class="r-stretch quarto-figure-center"><p class="caption">Source: DOI 10.3390/sym14122583</p><ul>
<li>You don’t need any math magic to write down differential equations from this model, you just need some training on how to read it.</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
\frac{dS}{dt} &amp;= -\beta I S \\
\frac{dI}{dt} &amp;= \beta I S - \gamma I \\
\frac{dR}{dt} &amp;= \gamma I
\end{aligned}
\]</span></p>
<ul>
<li>It is a true fact about differential equations that most (systems/equations) are impossible to solve via math magic, and we must resort to numerical solutions.</li>
<li>It is impossible to solve the SIR system analytically with normal math magic, although it is possible using functions you’ve never heard of.</li>
</ul>
</section>
<section id="sir-model-in-desolve" class="slide level2 scrollable">
<h2>SIR model in deSolve</h2>
<ul>
<li>Let’s walk through an example of solving SIR in deSolve.</li>
</ul>
<div class="fragment">
<ul>
<li>We need the following things to give to DSAIDE: a set of time points to evaluate our system at, a list of parameters of the system, an initial condition/state that describes the component populations at time <span class="math inline">\(0\)</span>, and a function that uses all of those things to update the system.</li>
</ul>
</div>
<div class="fragment">
<ul>
<li>Parameters: <span class="math inline">\(\beta\)</span> (the force of infection) and <span class="math inline">\(\gamma\)</span> (the recovery rate). I’ll arbitrarily set <span class="math inline">\(\beta = 0.01\)</span> and <span class="math inline">\(\gamma = 0.5\)</span> since I know it will make a good picture.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a></a>sir_parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">beta =</span> <span class="fl">0.01</span>, <span class="at">gamma =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="fragment">
<ul>
<li>Time points: it doesn’t really matter what we choose as long as it goes far enough out to see the patterns we’re interest in and is fine-grained enough to get good detail. For this problem we’ll use times of <span class="math inline">\(t = 0, 0.01, 0.02, \ldots, 9.99, 10\)</span>. Choosing the right ones usually takes some trial and error. Running more time points can take a really long time for complicated models.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a></a>t_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="fragment">
<ul>
<li>Initial state: we need how many susceptible, infected, and recovered people at time <span class="math inline">\(0\)</span>. Let’s say 1000 S, 1 I, and 0 R. Note you need at least one infected person to have an epidemic!</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a></a>sir_initial_condition <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="dv">1000</span>, <span class="at">I =</span> <span class="dv">1</span>, <span class="at">R =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="fragment">
<ul>
<li>A function. This is the tricky bit, and we have to write it kind of weird. We can leave out that weird <code>with()</code> thing from before, but it does make your life easier so I recommend learning it.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a></a>sir_ode <span class="ot">&lt;-</span> <span class="cf">function</span>(t, y, parameters) {</span>
<span id="cb22-2"><a></a>    <span class="co"># If you don't use with() you have to do this</span></span>
<span id="cb22-3"><a></a>    b <span class="ot">&lt;-</span> parameters[<span class="st">"beta"</span>]</span>
<span id="cb22-4"><a></a>    g <span class="ot">&lt;-</span> parameters[<span class="st">"gamma"</span>]</span>
<span id="cb22-5"><a></a>    </span>
<span id="cb22-6"><a></a>    S <span class="ot">&lt;-</span> y[<span class="st">"S"</span>]</span>
<span id="cb22-7"><a></a>    I <span class="ot">&lt;-</span> y[<span class="st">"I"</span>]</span>
<span id="cb22-8"><a></a>    R <span class="ot">&lt;-</span> y[<span class="st">"R"</span>]</span>
<span id="cb22-9"><a></a>    </span>
<span id="cb22-10"><a></a>    dS <span class="ot">&lt;-</span> <span class="sc">-</span>b <span class="sc">*</span> I <span class="sc">*</span> S</span>
<span id="cb22-11"><a></a>    dI <span class="ot">&lt;-</span> b <span class="sc">*</span> I <span class="sc">*</span> S <span class="sc">-</span> g <span class="sc">*</span> I</span>
<span id="cb22-12"><a></a>    dR <span class="ot">&lt;-</span> g <span class="sc">*</span> I</span>
<span id="cb22-13"><a></a>    </span>
<span id="cb22-14"><a></a>    <span class="co"># For deSolve the output always has to be a list like this</span></span>
<span id="cb22-15"><a></a>    out <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">c</span>(dS, dI, dR))</span>
<span id="cb22-16"><a></a>    <span class="fu">return</span>(out)</span>
<span id="cb22-17"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="fragment">
<ul>
<li>Now we should be able to call <code>deSolve</code> and get a solution.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a></a>sir_soln <span class="ot">&lt;-</span> deSolve<span class="sc">::</span><span class="fu">ode</span>(</span>
<span id="cb23-2"><a></a>    <span class="at">y =</span> sir_initial_condition,</span>
<span id="cb23-3"><a></a>    <span class="at">times =</span> t_seq,</span>
<span id="cb23-4"><a></a>    <span class="at">func =</span> sir_ode,</span>
<span id="cb23-5"><a></a>    <span class="at">parms =</span> sir_parms</span>
<span id="cb23-6"><a></a>)</span>
<span id="cb23-7"><a></a><span class="fu">head</span>(sir_soln)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: right;">time</th>
<th style="text-align: right;">S</th>
<th style="text-align: right;">I</th>
<th style="text-align: right;">R</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1000.0000</td>
<td style="text-align: right;">1.000000</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">999.8951</td>
<td style="text-align: right;">1.099654</td>
<td style="text-align: right;">0.0052452</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.02</td>
<td style="text-align: right;">999.7798</td>
<td style="text-align: right;">1.209224</td>
<td style="text-align: right;">0.0110131</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">999.6529</td>
<td style="text-align: right;">1.329698</td>
<td style="text-align: right;">0.0173557</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">999.5135</td>
<td style="text-align: right;">1.462153</td>
<td style="text-align: right;">0.0243301</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">999.3602</td>
<td style="text-align: right;">1.607779</td>
<td style="text-align: right;">0.0319991</td>
</tr>
</tbody>
</table>
</div>
</div>
<ul>
<li>Let’s plot the solution.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a></a><span class="fu">plot</span>(</span>
<span id="cb24-2"><a></a>    <span class="cn">NULL</span>, <span class="cn">NULL</span>,</span>
<span id="cb24-3"><a></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1000</span>),</span>
<span id="cb24-4"><a></a>    <span class="at">xlab =</span> <span class="st">"t"</span>, <span class="at">ylab =</span> <span class="st">"n"</span></span>
<span id="cb24-5"><a></a>)</span>
<span id="cb24-6"><a></a>my_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"deepskyblue2"</span>, <span class="st">"darkorange"</span>, <span class="st">"mediumseagreen"</span>)</span>
<span id="cb24-7"><a></a></span>
<span id="cb24-8"><a></a><span class="fu">lines</span>(sir_soln[,<span class="st">"time"</span>], sir_soln[,<span class="st">"S"</span>], <span class="at">col =</span> my_colors[<span class="dv">1</span>], <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb24-9"><a></a><span class="fu">lines</span>(sir_soln[,<span class="st">"time"</span>], sir_soln[,<span class="st">"I"</span>], <span class="at">col =</span> my_colors[<span class="dv">2</span>], <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb24-10"><a></a><span class="fu">lines</span>(sir_soln[,<span class="st">"time"</span>], sir_soln[,<span class="st">"R"</span>], <span class="at">col =</span> my_colors[<span class="dv">3</span>], <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb24-11"><a></a><span class="fu">legend</span>(</span>
<span id="cb24-12"><a></a>    <span class="st">"topright"</span>,</span>
<span id="cb24-13"><a></a>    <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>),</span>
<span id="cb24-14"><a></a>    <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> my_colors</span>
<span id="cb24-15"><a></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="ModuleXX-optim-differential-equations_files/figure-revealjs/unnamed-chunk-18-1.png" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="you-try-it-1" class="slide level2 scrollable">
<h2>You try it!</h2>
<ul>
<li>Update your model slightly so that people who are Recovered can become Susceptible again over time. This is called a SIRS model. It looks like this.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="../images/SIRS.png"></p>
<figcaption>Source: DOI 10.3390/sym14122583 with my edit</figcaption>
</figure>
</div>
<div class="fragment">
<ul>
<li>Hint: the system of equations implied by my incredible drawing is:</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
\frac{dS}{dt} &amp;= -\beta I S + \zeta R\\
\frac{dI}{dt} &amp;= \beta I S - \gamma I \\
\frac{dR}{dt} &amp;= \gamma I - \zeta R
\end{aligned}
\]</span></p>
</div>
<div class="fragment">
<ul>
<li>Hint: you need to add another parameter and update the function, but you don’t need to change anything about the initial state or time values (if you don’t want to).</li>
</ul>
</div>
<div class="fragment">
<ul>
<li>Solution!</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a></a>sirs_initial_condition <span class="ot">&lt;-</span> sir_initial_condition</span>
<span id="cb25-2"><a></a>sirs_t <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1000</span>, <span class="fl">0.01</span>)</span>
<span id="cb25-3"><a></a>sirs_parms <span class="ot">&lt;-</span> <span class="fu">c</span>(sir_parms, <span class="at">zeta =</span> <span class="fl">0.25</span>)</span>
<span id="cb25-4"><a></a>sirs_ode <span class="ot">&lt;-</span> <span class="cf">function</span>(t, y, parameters) {</span>
<span id="cb25-5"><a></a>    <span class="co"># If you don't use with() you have to do this</span></span>
<span id="cb25-6"><a></a>    b <span class="ot">&lt;-</span> parameters[<span class="st">"beta"</span>]</span>
<span id="cb25-7"><a></a>    g <span class="ot">&lt;-</span> parameters[<span class="st">"gamma"</span>]</span>
<span id="cb25-8"><a></a>    z <span class="ot">&lt;-</span> parameters[<span class="st">"zeta"</span>]</span>
<span id="cb25-9"><a></a>    </span>
<span id="cb25-10"><a></a>    S <span class="ot">&lt;-</span> y[<span class="st">"S"</span>]</span>
<span id="cb25-11"><a></a>    I <span class="ot">&lt;-</span> y[<span class="st">"I"</span>]</span>
<span id="cb25-12"><a></a>    R <span class="ot">&lt;-</span> y[<span class="st">"R"</span>]</span>
<span id="cb25-13"><a></a>    </span>
<span id="cb25-14"><a></a>    dS <span class="ot">&lt;-</span> <span class="sc">-</span>b <span class="sc">*</span> I <span class="sc">*</span> S <span class="sc">+</span> z <span class="sc">*</span> R</span>
<span id="cb25-15"><a></a>    dI <span class="ot">&lt;-</span> b <span class="sc">*</span> I <span class="sc">*</span> S <span class="sc">-</span> g <span class="sc">*</span> I</span>
<span id="cb25-16"><a></a>    dR <span class="ot">&lt;-</span> g <span class="sc">*</span> I <span class="sc">-</span> z <span class="sc">*</span> R</span>
<span id="cb25-17"><a></a>    </span>
<span id="cb25-18"><a></a>    <span class="co"># For deSolve the output always has to be a list like this</span></span>
<span id="cb25-19"><a></a>    out <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">c</span>(dS, dI, dR))</span>
<span id="cb25-20"><a></a>    <span class="fu">return</span>(out)</span>
<span id="cb25-21"><a></a>}</span>
<span id="cb25-22"><a></a></span>
<span id="cb25-23"><a></a>sirs_soln <span class="ot">&lt;-</span> deSolve<span class="sc">::</span><span class="fu">ode</span>(</span>
<span id="cb25-24"><a></a>    <span class="at">y =</span> sirs_initial_condition,</span>
<span id="cb25-25"><a></a>    <span class="at">times =</span> sirs_t,</span>
<span id="cb25-26"><a></a>    <span class="at">func =</span> sirs_ode,</span>
<span id="cb25-27"><a></a>    <span class="at">parms =</span> sirs_parms</span>
<span id="cb25-28"><a></a>)</span>
<span id="cb25-29"><a></a><span class="fu">head</span>(sirs_soln)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: right;">time</th>
<th style="text-align: right;">S</th>
<th style="text-align: right;">I</th>
<th style="text-align: right;">R</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1000.0000</td>
<td style="text-align: right;">1.000000</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">999.8951</td>
<td style="text-align: right;">1.099654</td>
<td style="text-align: right;">0.0052388</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.02</td>
<td style="text-align: right;">999.7798</td>
<td style="text-align: right;">1.209224</td>
<td style="text-align: right;">0.0109865</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">999.6530</td>
<td style="text-align: right;">1.329698</td>
<td style="text-align: right;">0.0172938</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">999.5136</td>
<td style="text-align: right;">1.462153</td>
<td style="text-align: right;">0.0242165</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">999.3604</td>
<td style="text-align: right;">1.607779</td>
<td style="text-align: right;">0.0318156</td>
</tr>
</tbody>
</table>
</div>
</div>
<ul>
<li>Let’s plot this solution the same way.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a></a><span class="fu">plot</span>(</span>
<span id="cb26-2"><a></a>    <span class="cn">NULL</span>, <span class="cn">NULL</span>,</span>
<span id="cb26-3"><a></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1000</span>),</span>
<span id="cb26-4"><a></a>    <span class="at">xlab =</span> <span class="st">"t"</span>, <span class="at">ylab =</span> <span class="st">"n"</span>,</span>
<span id="cb26-5"><a></a>    <span class="at">main =</span> <span class="st">"SIRS model solution"</span></span>
<span id="cb26-6"><a></a>)</span>
<span id="cb26-7"><a></a>my_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"deepskyblue2"</span>, <span class="st">"darkorange"</span>, <span class="st">"mediumseagreen"</span>)</span>
<span id="cb26-8"><a></a></span>
<span id="cb26-9"><a></a><span class="fu">lines</span>(sirs_soln[,<span class="st">"time"</span>], sirs_soln[,<span class="st">"S"</span>], <span class="at">col =</span> my_colors[<span class="dv">1</span>], <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb26-10"><a></a><span class="fu">lines</span>(sirs_soln[,<span class="st">"time"</span>], sirs_soln[,<span class="st">"I"</span>], <span class="at">col =</span> my_colors[<span class="dv">2</span>], <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb26-11"><a></a><span class="fu">lines</span>(sirs_soln[,<span class="st">"time"</span>], sirs_soln[,<span class="st">"R"</span>], <span class="at">col =</span> my_colors[<span class="dv">3</span>], <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb26-12"><a></a><span class="fu">legend</span>(</span>
<span id="cb26-13"><a></a>    <span class="st">"topright"</span>,</span>
<span id="cb26-14"><a></a>    <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>),</span>
<span id="cb26-15"><a></a>    <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> my_colors</span>
<span id="cb26-16"><a></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="ModuleXX-optim-differential-equations_files/figure-revealjs/unnamed-chunk-20-1.png" width="960"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>By including the <span class="math inline">\(\zeta\)</span> parameter, we get an endemic equilibrium instead of a disease-free equilibrium.</li>
<li>This model can give you some other interesting oscillation patterns if you play with the parameters, but almost all parameter combinations will lead to a steady state.</li>
</ul>
</div>
</section>
<section id="you-try-it-problem-2" class="slide level2 scrollable">
<h2>You try it (problem 2)</h2>
<ul>
<li>If you’re ready for another challenge, try solving the equations for this model where the pathogen is environmental.</li>
<li>This model also includes a birth rate <span class="math inline">\(n\)</span> (assuming all individuals are born into the susceptible compartment) and a death rate <span class="math inline">\(m\)</span> that assumes people from the S, I, and R compartments all die at the same rate. If you want to, you can leave out any terms with <span class="math inline">\(m\)</span> and <span class="math inline">\(n\)</span> in them, they aren’t too important (or you can set them to 0 in your model).</li>
</ul>
<p><img data-src="../images/sirp.png" alt="Source: Andreas Handel’s DSAIDE package"> - Here are the equations implied by the model. <span class="math display">\[
\begin{aligned}
\frac{dS}{dt} &amp;= n - b_{I}IS - b_{P}PS -mS \\
\frac{dI}{dt} &amp;= b_{I}IS + b_{I}PS -gI - mI\\
\frac{dR}{dt} &amp;= gI - mR \\
\frac{dP}{dt} &amp;= qI - cP
\end{aligned}
\]</span></p>
<ul>
<li>No solution typed out for this problem. You can work on it on your own and email me questions, or if we have time we can work on it together.</li>
</ul>
</section>
<section id="more-resources" class="slide level2">
<h2>More resources</h2>
<ul>
<li>Differential equations are actually really fun. For a quick introduction (requires calculus) I recommend “Differential Equations in 24 Hours” by Scott Imhoff.</li>
<li>For a no-code no-calculus exploration of epidemiology DE’s, take a look at Andreas Handel’s R packages <a href="https://cran.csail.mit.edu/web/packages/DSAIRM/index.html">DSAIRM</a> (within-host models) and <a href="https://cran.r-project.org/web//packages//DSAIDE/index.html">DSAIDE</a> (between-host models).</li>
<li>Or there are MANY other SISMID courses about ODE modeling.</li>
</ul>
</section>
<section id="bonus-stage-desolve-and-optim" class="slide level2 scrollable">
<h2>Bonus stage: <code>deSolve</code> AND <code>optim</code></h2>
<ul>
<li>If you have observed epidemic data, you can actually estimate the parameters of an ODE system.</li>
<li>It’s much more difficult than estimating a linear model, though.</li>
<li>Suppose we’ve observed the data in <code>SIR-observed.csv</code> and we want to estimate parameters assuming an SIR model fits the best. Note that we typically only observe case counts in real data, so that’s what is in this data.</li>
<li>Let’s walk through a quick implementation of a model fit. First load the data.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a></a>dat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"SIR-observed.csv"</span>))</span>
<span id="cb27-2"><a></a><span class="fu">head</span>(dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: right;">day</th>
<th style="text-align: right;">total_cases</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">22</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">44</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">109</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">271</td>
</tr>
</tbody>
</table>
</div>
</div>
<ul>
<li>We can use all the stuff we already built for an SIR model <code>deSolve</code> run. The hard part is figuring out how to fit it to our data.</li>
</ul>
<div class="fragment">
<ul>
<li>The easiest way is to use the SSR on the case counts, so we’ll minimize <span class="math display">\[
SSR = \sum_{i = 1}^n \bigg(I - \hat{I}(\beta, \gamma)\bigg)^2
\]</span> where <span class="math inline">\(\hat{I}(\beta, \gamma)\)</span> are the case counts predicted by an SIR model with parameters <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\gamma\)</span>.</li>
<li>So we need to define a function for optim that takes the parameters as an argument, calculates the <span class="math inline">\(\hat{I}\)</span> values for those parameters, and then gets the SSR between the observed and predicted case counts.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a></a>sir_pred <span class="ot">&lt;-</span> <span class="cf">function</span>(par) {</span>
<span id="cb28-2"><a></a>    sir_parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">beta =</span> par[<span class="dv">1</span>], <span class="at">gamma =</span> par[<span class="dv">2</span>])</span>
<span id="cb28-3"><a></a>    sir_initial_condition <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="dv">1000</span>, <span class="at">I =</span> <span class="dv">1</span>, <span class="at">R =</span> <span class="dv">0</span>)</span>
<span id="cb28-4"><a></a>    times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb28-5"><a></a>    </span>
<span id="cb28-6"><a></a>    sim <span class="ot">&lt;-</span> deSolve<span class="sc">::</span><span class="fu">ode</span>(</span>
<span id="cb28-7"><a></a>        <span class="at">y =</span> sir_initial_condition,</span>
<span id="cb28-8"><a></a>        <span class="at">times =</span> times,</span>
<span id="cb28-9"><a></a>        <span class="at">fun =</span> sir_ode,</span>
<span id="cb28-10"><a></a>        <span class="at">parms =</span> sir_parms</span>
<span id="cb28-11"><a></a>    )</span>
<span id="cb28-12"><a></a>    </span>
<span id="cb28-13"><a></a>    i_hat <span class="ot">&lt;-</span> sim[, <span class="st">"I"</span>]</span>
<span id="cb28-14"><a></a>    fit_ssr <span class="ot">&lt;-</span> <span class="fu">sum</span>((dat<span class="sc">$</span>total_cases <span class="sc">-</span> i_hat) <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb28-15"><a></a>    <span class="fu">return</span>(fit_ssr)</span>
<span id="cb28-16"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Now we can run <code>optim()</code>.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a></a>res <span class="ot">&lt;-</span> <span class="fu">optim</span>(</span>
<span id="cb29-2"><a></a>    <span class="at">par =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>),</span>
<span id="cb29-3"><a></a>    <span class="at">fn =</span> sir_pred,</span>
<span id="cb29-4"><a></a>    <span class="at">hessian =</span> <span class="cn">TRUE</span>,</span>
<span id="cb29-5"><a></a>    <span class="at">method =</span> <span class="st">"L-BFGS-B"</span>,</span>
<span id="cb29-6"><a></a>    <span class="at">lower =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb29-7"><a></a>)</span>
<span id="cb29-8"><a></a></span>
<span id="cb29-9"><a></a>point_sir <span class="ot">&lt;-</span> res<span class="sc">$</span>par</span>
<span id="cb29-10"><a></a>se_sir <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">solve</span>(res<span class="sc">$</span>hessian)))</span>
<span id="cb29-11"><a></a>ci_sir <span class="ot">&lt;-</span> point_sir <span class="sc">+</span> <span class="fu">outer</span>(se_sir, <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>))</span>
<span id="cb29-12"><a></a></span>
<span id="cb29-13"><a></a>out <span class="ot">&lt;-</span> <span class="fu">cbind</span>(point_sir, ci_sir) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">5</span>)</span>
<span id="cb29-14"><a></a><span class="fu">rownames</span>(out) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"gamma"</span>)</span>
<span id="cb29-15"><a></a><span class="fu">colnames</span>(out) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"point"</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span>)</span>
<span id="cb29-16"><a></a>out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">point</th>
<th style="text-align: right;">lower</th>
<th style="text-align: right;">upper</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">beta</td>
<td style="text-align: right;">3.62954</td>
<td style="text-align: right;">3.40695</td>
<td style="text-align: right;">3.85213</td>
</tr>
<tr class="even">
<td style="text-align: left;">gamma</td>
<td style="text-align: right;">0.04126</td>
<td style="text-align: right;">0.04124</td>
<td style="text-align: right;">0.04128</td>
</tr>
</tbody>
</table>
</div>
</div>
<ul>
<li>We can see that we’re quite confidence in our estimates of <span class="math inline">\(\beta \approx 3.6\)</span> and <span class="math inline">\(\gamma \approx 0.04\)</span>.</li>
</ul>
</div>
<div class="fragment">
<ul>
<li>The problem with that is that those are nowhere close to the parameters I used to simulate the data (beta = 0.001, gamma = 0.05).</li>
<li>These differential equation models are hard to optimize! But there are other SISMID modules that focus on how to make these models work right, we just want you to be able to program them.</li>
</ul>
</div>
<div class="fragment">
<ul>
<li>Part of the problem is that this is very sensitive to the choice of optimizer. If we rewrite our function to implicitly have the 0 boundary constraint we can use unconstrained optimizers.</li>
<li>Some are much worse for this problem (Nelder-Mead) and others (simulated annealing) can be better. In particular, simulated annealing is stochastic and will sometimes generate a very good answer and sometimes will not.</li>
<li>Getting a handle on these kind of problems requires a lot of practice and involves a lot of stuff that we unfortunately don’t have time to talk about.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a></a>sir_pred <span class="ot">&lt;-</span> <span class="cf">function</span>(par) {</span>
<span id="cb30-2"><a></a>    sir_parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">beta =</span> par[<span class="dv">1</span>], <span class="at">gamma =</span> par[<span class="dv">2</span>])</span>
<span id="cb30-3"><a></a>    sir_initial_condition <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="dv">1000</span>, <span class="at">I =</span> <span class="dv">1</span>, <span class="at">R =</span> <span class="dv">0</span>)</span>
<span id="cb30-4"><a></a>    times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb30-5"><a></a>    </span>
<span id="cb30-6"><a></a>    <span class="co"># New part</span></span>
<span id="cb30-7"><a></a>    <span class="co"># Return a huge number if the paramaters are negative</span></span>
<span id="cb30-8"><a></a>    <span class="cf">if</span> (<span class="fu">any</span>(par <span class="sc">&lt;=</span> <span class="dv">0</span>)) <span class="fu">return</span>(<span class="fl">1e12</span>)</span>
<span id="cb30-9"><a></a>    </span>
<span id="cb30-10"><a></a>    sim <span class="ot">&lt;-</span> deSolve<span class="sc">::</span><span class="fu">ode</span>(</span>
<span id="cb30-11"><a></a>        <span class="at">y =</span> sir_initial_condition,</span>
<span id="cb30-12"><a></a>        <span class="at">times =</span> times,</span>
<span id="cb30-13"><a></a>        <span class="at">fun =</span> sir_ode,</span>
<span id="cb30-14"><a></a>        <span class="at">parms =</span> sir_parms</span>
<span id="cb30-15"><a></a>    )</span>
<span id="cb30-16"><a></a>    </span>
<span id="cb30-17"><a></a>    i_hat <span class="ot">&lt;-</span> sim[, <span class="st">"I"</span>]</span>
<span id="cb30-18"><a></a>    fit_ssr <span class="ot">&lt;-</span> <span class="fu">sum</span>((dat<span class="sc">$</span>total_cases <span class="sc">-</span> i_hat) <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb30-19"><a></a>    <span class="fu">return</span>(fit_ssr)</span>
<span id="cb30-20"><a></a>}</span>
<span id="cb30-21"><a></a></span>
<span id="cb30-22"><a></a><span class="fu">set.seed</span>(<span class="dv">103</span>)</span>
<span id="cb30-23"><a></a>res <span class="ot">&lt;-</span> <span class="fu">optim</span>(</span>
<span id="cb30-24"><a></a>    <span class="at">par =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>),</span>
<span id="cb30-25"><a></a>    <span class="at">fn =</span> sir_pred,</span>
<span id="cb30-26"><a></a>    <span class="at">hessian =</span> <span class="cn">TRUE</span>,</span>
<span id="cb30-27"><a></a>    <span class="co"># Use simulated annealing, which can be better for these kind of problems.</span></span>
<span id="cb30-28"><a></a>    <span class="at">method =</span> <span class="st">"SANN"</span></span>
<span id="cb30-29"><a></a>)</span>
<span id="cb30-30"><a></a></span>
<span id="cb30-31"><a></a>point_sir <span class="ot">&lt;-</span> res<span class="sc">$</span>par</span>
<span id="cb30-32"><a></a>se_sir <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">solve</span>(res<span class="sc">$</span>hessian)))</span>
<span id="cb30-33"><a></a>ci_sir <span class="ot">&lt;-</span> point_sir <span class="sc">+</span> <span class="fu">outer</span>(se_sir, <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>))</span>
<span id="cb30-34"><a></a></span>
<span id="cb30-35"><a></a>out <span class="ot">&lt;-</span> <span class="fu">cbind</span>(point_sir, ci_sir) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">5</span>)</span>
<span id="cb30-36"><a></a><span class="fu">rownames</span>(out) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"gamma"</span>)</span>
<span id="cb30-37"><a></a><span class="fu">colnames</span>(out) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"point"</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span>)</span>
<span id="cb30-38"><a></a>out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">point</th>
<th style="text-align: right;">lower</th>
<th style="text-align: right;">upper</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">beta</td>
<td style="text-align: right;">0.00100</td>
<td style="text-align: right;">0.00100</td>
<td style="text-align: right;">0.00100</td>
</tr>
<tr class="even">
<td style="text-align: left;">gamma</td>
<td style="text-align: right;">0.05441</td>
<td style="text-align: right;">0.05438</td>
<td style="text-align: right;">0.05445</td>
</tr>
</tbody>
</table>
</div>
</div>


</div>
</section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: false,

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    

    <script>

      // htmlwidgets need to know to resize themselves when slides are shown/hidden.

      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current

      // slide changes (different for each slide format).

      (function () {

        // dispatch for htmlwidgets

        function fireSlideEnter() {

          const event = window.document.createEvent("Event");

          event.initEvent("slideenter", true, true);

          window.document.dispatchEvent(event);

        }

    

        function fireSlideChanged(previousSlide, currentSlide) {

          fireSlideEnter();

    

          // dispatch for shiny

          if (window.jQuery) {

            if (previousSlide) {

              window.jQuery(previousSlide).trigger("hidden");

            }

            if (currentSlide) {

              window.jQuery(currentSlide).trigger("shown");

            }

          }

        }

    

        // hookup for slidy

        if (window.w3c_slidy) {

          window.w3c_slidy.add_observer(function (slide_num) {

            // slide_num starts at position 1

            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);

          });

        }

    

      })();

    </script>

    

    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp('/' + window.location.host + '/');
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>